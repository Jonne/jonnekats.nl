---
layout: post
title: Integrate xUnit tests into your daily Team Build
date: 2009-05-07
author: jonnekats
comments: true
tags: [General, Test driven development, tfs, xunit]
---
Doing proper Test Driven Development with the default visual studio test runner (mstest) is like playing Gears of War 2 on an old fashioned tube television, it’s just wrong ;).. There are several alternatives out there like mbUnit and nUnit, but my favorite is xUnit. xUnit is heavily extensible and there is a project called <a href="http://code.google.com/p/xunitbddextensions/" target="_blank">xunitbddextensions</a>, which extends xunit making it possible to do specication based testing (<a href="http://en.wikipedia.org/wiki/Behavior_Driven_Development" target="_blank">BDD</a>). Using resharper or testdriven.net this makes for an excellent experience when developing in visual studio. xUnit tests can also be integrated into your daily TFS (Microsoft Team Foundation Server) build by using the xUnit build task. However, the details of the testresults are not displayed in the build overview and the results are not used in the reporting functionality of TFS (Like the Quality Indicators report).

On the xUnit site there is some discussion about this functionality, but at the moment there is no implementation. For nUnit there is a project on codeplex called <a href="http://www.codeplex.com/nunit4teambuild" target="_blank">nUnit for Team Build</a>. This consists of a sample build script that uses an XSLT file to translate the xml results of nUnit into a visual studio test result file and publishes this result to TFS. This way integrating the nUnit test results into TFS.

I figured I could modify the XSLT file to translate the xUnit tests results instead. However, having a better look at the xUnit build task I noticed a NunitXml property, which makes it possible to output the xUnit results into a nUnit compatible xml file.  So I could just use the XSLT file and integrate the xUnit results into our TFS build.

To make this work I only had to modify the build script to use the xUnit build task instead of  the nUnit build task. This resulted in the following script (This just needs to be added to the end of your build definition):
<div class="wlWriterEditableSmartContent" id="scid:57F11A72-B0E5-49c7-9094-E3A15BD5B5E6:611e04d8-0ebe-46f2-b3f3-5a8abbeddeee" style="display:inline;float:none;margin:0;padding:0;">
<pre style="background-color:#ffffff;white-space:pre-wrap;overflow:auto;"><span style="color:#008000;">&lt;!--</span><span style="color:#008000;"> Xunit Build task</span><span style="color:#008000;">--&gt;</span><span style="color:#0000ff;">&lt;</span><span style="color:#800000;">PropertyGroup</span><span style="color:#0000ff;">&gt;</span><span style="color:#0000ff;">&lt;</span><span style="color:#800000;">XunitBuildTaskPath</span><span style="color:#0000ff;">&gt;</span><span style="color:#000000;">$(ProgramFiles)\MSBuild\Xunit\</span><span style="color:#0000ff;">&lt;/</span><span style="color:#800000;">XunitBuildTaskPath</span><span style="color:#0000ff;">&gt;</span><span style="color:#0000ff;">&lt;/</span><span style="color:#800000;">PropertyGroup</span><span style="color:#0000ff;">&gt;</span><span style="color:#0000ff;">&lt;</span><span style="color:#800000;">UsingTask </span><span style="color:#ff0000;">AssemblyFile</span><span style="color:#0000ff;">="$(XunitBuildTaskPath)\xunit.runner.msbuild.dll"</span><span style="color:#ff0000;">
    TaskName</span><span style="color:#0000ff;">="Xunit.Runner.MSBuild.xunit"</span><span style="color:#0000ff;">/&gt;</span><span style="color:#0000ff;">&lt;</span><span style="color:#800000;">Target </span><span style="color:#ff0000;">Name</span><span style="color:#0000ff;">="AfterCompile"</span><span style="color:#0000ff;">&gt;</span><span style="color:#008000;">&lt;!--</span><span style="color:#008000;"> Create a Custom Build Step </span><span style="color:#008000;">--&gt;</span><span style="color:#0000ff;">&lt;</span><span style="color:#800000;">BuildStep </span><span style="color:#ff0000;">TeamFoundationServerUrl</span><span style="color:#0000ff;">="$(TeamFoundationServerUrl)"</span><span style="color:#ff0000;"> BuildUri</span><span style="color:#0000ff;">="$(BuildUri)"</span><span style="color:#ff0000;"> Name</span><span style="color:#0000ff;">="XUnitTestStep"</span><span style="color:#ff0000;"> Message</span><span style="color:#0000ff;">="Running Xunit Tests"</span><span style="color:#0000ff;">&gt;</span><span style="color:#0000ff;">&lt;</span><span style="color:#800000;">Output </span><span style="color:#ff0000;">TaskParameter</span><span style="color:#0000ff;">="Id"</span><span style="color:#ff0000;"> PropertyName</span><span style="color:#0000ff;">="XUnitStepId"</span><span style="color:#0000ff;">/&gt;</span><span style="color:#0000ff;">&lt;/</span><span style="color:#800000;">BuildStep</span><span style="color:#0000ff;">&gt;</span><span style="color:#0000ff;">&lt;</span><span style="color:#800000;">CreateItem </span><span style="color:#ff0000;">Include</span><span style="color:#0000ff;">="$(OutDir)\*.Test.dll"</span><span style="color:#0000ff;">&gt;</span><span style="color:#0000ff;">&lt;</span><span style="color:#800000;">Output </span><span style="color:#ff0000;">TaskParameter</span><span style="color:#0000ff;">="Include"</span><span style="color:#ff0000;"> ItemName</span><span style="color:#0000ff;">="TestAssemblies"</span><span style="color:#0000ff;">/&gt;</span><span style="color:#0000ff;">&lt;/</span><span style="color:#800000;">CreateItem</span><span style="color:#0000ff;">&gt;</span><span style="color:#008000;">&lt;!--</span><span style="color:#008000;"> Run the tests </span><span style="color:#008000;">--&gt;</span><span style="color:#0000ff;">&lt;</span><span style="color:#800000;">xunit </span><span style="color:#ff0000;">ContinueOnError</span><span style="color:#0000ff;">="true"</span><span style="color:#ff0000;"> Assembly</span><span style="color:#0000ff;">="@(TestAssemblies)"</span><span style="color:#ff0000;"> NUnitXml</span><span style="color:#0000ff;">="$(OutDir)nunit_results.xml"</span><span style="color:#0000ff;">&gt;</span><span style="color:#0000ff;">&lt;</span><span style="color:#800000;">Output </span><span style="color:#ff0000;">TaskParameter</span><span style="color:#0000ff;">="ExitCode"</span><span style="color:#ff0000;"> PropertyName</span><span style="color:#0000ff;">="XUnitResult"</span><span style="color:#0000ff;">/&gt;</span><span style="color:#0000ff;">&lt;/</span><span style="color:#800000;">xunit</span><span style="color:#0000ff;">&gt;</span><span style="color:#008000;">&lt;!--</span><span style="color:#008000;"> Set the status of the buildstep in the build overview </span><span style="color:#008000;">--&gt;</span><span style="color:#0000ff;">&lt;</span><span style="color:#800000;">BuildStep </span><span style="color:#ff0000;">Condition</span><span style="color:#0000ff;">="'$(XUnitResult)'=='0'"</span><span style="color:#ff0000;"> TeamFoundationServerUrl</span><span style="color:#0000ff;">="$(TeamFoundationServerUrl)"</span><span style="color:#ff0000;"> BuildUri</span><span style="color:#0000ff;">="$(BuildUri)"</span><span style="color:#ff0000;"> Id</span><span style="color:#0000ff;">="$(XUnitStepId)"</span><span style="color:#ff0000;"> Status</span><span style="color:#0000ff;">="Succeeded"</span><span style="color:#0000ff;">/&gt;</span><span style="color:#0000ff;">&lt;</span><span style="color:#800000;">BuildStep </span><span style="color:#ff0000;">Condition</span><span style="color:#0000ff;">="'$(XUnitResult)'!='0'"</span><span style="color:#ff0000;"> TeamFoundationServerUrl</span><span style="color:#0000ff;">="$(TeamFoundationServerUrl)"</span><span style="color:#ff0000;"> BuildUri</span><span style="color:#0000ff;">="$(BuildUri)"</span><span style="color:#ff0000;"> Id</span><span style="color:#0000ff;">="$(XUnitStepId)"</span><span style="color:#ff0000;"> Status</span><span style="color:#0000ff;">="Failed"</span><span style="color:#0000ff;">/&gt;</span><span style="color:#008000;">&lt;!--</span><span style="color:#008000;"> Regardless of NUnit success/failure merge results into the build </span><span style="color:#008000;">--&gt;</span><span style="color:#0000ff;">&lt;</span><span style="color:#800000;">Exec </span><span style="color:#ff0000;">Command</span><span style="color:#0000ff;">="&amp;quot;$(XunitBuildTaskPath)\nxslt3.exe&amp;quot; &amp;quot;$(OutDir)nunit_results.xml&amp;quot; &amp;quot;$(XunitBuildTaskPath)\nunit transform.xslt&amp;quot; -o &amp;quot;$(OutDir)xunit_results.trx&amp;quot;"</span><span style="color:#0000ff;">/&gt;</span><span style="color:#0000ff;">&lt;</span><span style="color:#800000;">Exec </span><span style="color:#ff0000;">Command</span><span style="color:#0000ff;">="&amp;quot;$(ProgramFiles)\Microsoft Visual Studio 9.0\Common7\IDE\mstest.exe&amp;quot; /publish:$(TeamFoundationServerUrl) /publishbuild:&amp;quot;$(BuildNumber)&amp;quot; /publishresultsfile:&amp;quot;$(OutDir)xunit_results.trx&amp;quot; /teamproject:&amp;quot;$(TeamProject)&amp;quot; /platform:&amp;quot;%(ConfigurationToBuild.PlatformToBuild)&amp;quot; /flavor:&amp;quot;%(ConfigurationToBuild.FlavorToBuild)&amp;quot;"</span><span style="color:#0000ff;">/&gt;</span><span style="color:#0000ff;">&lt;</span><span style="color:#800000;">Error </span><span style="color:#ff0000;">Condition</span><span style="color:#0000ff;">="'$(XUnitResult)'!='0'"</span><span style="color:#ff0000;"> Text</span><span style="color:#0000ff;">="XUnit Tests Failed"</span><span style="color:#0000ff;">/&gt;</span><span style="color:#0000ff;">&lt;/</span><span style="color:#800000;">Target</span><span style="color:#0000ff;">&gt;</span></pre>
<!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com -->

</div>
This script assumes you have copied the xunit  build task, the XSLT file and the nxslt3.exe file to a \MSBuild\Xunit\ folder under the program files folder on your build server.

Whether the tests fail or not, the resuls should always be published. However, the xUnit build task does not have an ExitCode and I could not find another way to get the result from the xUnit task. So I have modified the xUnit task to provide an ExitCode. Open up the xUnit code from codeplex. Locate the xunit.runner.msbuild project and open up the xUnit class. Add the following property and modify the Excute method to modify the value:
<div class="wlWriterEditableSmartContent" id="scid:57F11A72-B0E5-49c7-9094-E3A15BD5B5E6:e5c91279-12f7-4286-85b0-7e6bffb8566d" style="display:inline;float:none;margin:0;padding:0;">
<pre style="background-color:#ffffff;white-space:pre-wrap;overflow:auto;"><span style="color:#000000;">        [Output]
        </span><span style="color:#0000ff;">public</span><span style="color:#0000ff;">int</span><span style="color:#000000;"> ExitCode { </span><span style="color:#0000ff;">get</span><span style="color:#000000;">; </span><span style="color:#0000ff;">private</span><span style="color:#0000ff;">set</span><span style="color:#000000;">; }

        </span><span style="color:#0000ff;">public</span><span style="color:#0000ff;">override</span><span style="color:#0000ff;">bool</span><span style="color:#000000;"> Execute()
        {
            </span><span style="color:#0000ff;">try</span><span style="color:#000000;">
            {
                </span><span style="color:#0000ff;">string</span><span style="color:#000000;"> assemblyFilename </span><span style="color:#000000;">=</span><span style="color:#000000;"> Assembly.GetMetadata(</span><span style="color:#800000;">"</span><span style="color:#800000;">FullPath</span><span style="color:#800000;">"</span><span style="color:#000000;">);

                </span><span style="color:#0000ff;">if</span><span style="color:#000000;"> (WorkingFolder </span><span style="color:#000000;">!=</span><span style="color:#0000ff;">null</span><span style="color:#000000;">)
                    Directory.SetCurrentDirectory(WorkingFolder);

                </span><span style="color:#0000ff;">using</span><span style="color:#000000;"> (ExecutorWrapper wrapper </span><span style="color:#000000;">=</span><span style="color:#0000ff;">new</span><span style="color:#000000;"> ExecutorWrapper(assemblyFilename, ConfigFile, ShadowCopy))
                {
                    Log.LogMessage(MessageImportance.High, </span><span style="color:#800000;">"</span><span style="color:#800000;">xUnit.net MSBuild runner (xunit.dll version {0})</span><span style="color:#800000;">"</span><span style="color:#000000;">, wrapper.XunitVersion);
                    Log.LogMessage(MessageImportance.High, </span><span style="color:#800000;">"</span><span style="color:#800000;">Test assembly: {0}</span><span style="color:#800000;">"</span><span style="color:#000000;">, assemblyFilename);

                    IRunnerLogger logger </span><span style="color:#000000;">=</span><span style="color:#000000;">
                        TeamCity </span><span style="color:#000000;">?</span><span style="color:#000000;"> (IRunnerLogger)</span><span style="color:#0000ff;">new</span><span style="color:#000000;"> TeamCityLogger(Log) :
                        Verbose </span><span style="color:#000000;">?</span><span style="color:#0000ff;">new</span><span style="color:#000000;"> VerboseLogger(Log) :
                        </span><span style="color:#0000ff;">new</span><span style="color:#000000;"> StandardLogger(Log);

                    List</span><span style="color:#000000;">&lt;</span><span style="color:#000000;">IResultXmlTransform</span><span style="color:#000000;">&gt;</span><span style="color:#000000;"> transforms </span><span style="color:#000000;">=</span><span style="color:#0000ff;">new</span><span style="color:#000000;"> List</span><span style="color:#000000;">&lt;</span><span style="color:#000000;">IResultXmlTransform</span><span style="color:#000000;">&gt;</span><span style="color:#000000;">();

                    </span><span style="color:#0000ff;">using</span><span style="color:#000000;"> (Stream htmlStream </span><span style="color:#000000;">=</span><span style="color:#000000;"> ResourceStream(</span><span style="color:#800000;">"</span><span style="color:#800000;">HTML.xslt</span><span style="color:#800000;">"</span><span style="color:#000000;">))
                    </span><span style="color:#0000ff;">using</span><span style="color:#000000;"> (Stream nunitStream </span><span style="color:#000000;">=</span><span style="color:#000000;"> ResourceStream(</span><span style="color:#800000;">"</span><span style="color:#800000;">NUnitXml.xslt</span><span style="color:#800000;">"</span><span style="color:#000000;">))
                    {
                        </span><span style="color:#0000ff;">if</span><span style="color:#000000;"> (Xml </span><span style="color:#000000;">!=</span><span style="color:#0000ff;">null</span><span style="color:#000000;">)
                            transforms.Add(</span><span style="color:#0000ff;">new</span><span style="color:#000000;"> NullTransformer(Xml.GetMetadata(</span><span style="color:#800000;">"</span><span style="color:#800000;">FullPath</span><span style="color:#800000;">"</span><span style="color:#000000;">)));
                        </span><span style="color:#0000ff;">if</span><span style="color:#000000;"> (Html </span><span style="color:#000000;">!=</span><span style="color:#0000ff;">null</span><span style="color:#000000;">)
                            transforms.Add(</span><span style="color:#0000ff;">new</span><span style="color:#000000;"> XslStreamTransformer(htmlStream, Html.GetMetadata(</span><span style="color:#800000;">"</span><span style="color:#800000;">FullPath</span><span style="color:#800000;">"</span><span style="color:#000000;">), </span><span style="color:#800000;">"</span><span style="color:#800000;">HTML</span><span style="color:#800000;">"</span><span style="color:#000000;">));
                        </span><span style="color:#0000ff;">if</span><span style="color:#000000;"> (NUnitXml </span><span style="color:#000000;">!=</span><span style="color:#0000ff;">null</span><span style="color:#000000;">)
                            transforms.Add(</span><span style="color:#0000ff;">new</span><span style="color:#000000;"> XslStreamTransformer(nunitStream, NUnitXml.GetMetadata(</span><span style="color:#800000;">"</span><span style="color:#800000;">FullPath</span><span style="color:#800000;">"</span><span style="color:#000000;">), </span><span style="color:#800000;">"</span><span style="color:#800000;">NUnit XML</span><span style="color:#800000;">"</span><span style="color:#000000;">));

                        TestRunner runner </span><span style="color:#000000;">=</span><span style="color:#0000ff;">new</span><span style="color:#000000;"> TestRunner(wrapper, logger);
                        </span><span style="color:#0000ff;">if</span><span style="color:#000000;">(runner.RunAssembly(transforms) </span><span style="color:#000000;">==</span><span style="color:#000000;"> TestRunnerResult.Failed)
                        {
                            ExitCode </span><span style="color:#000000;">=</span><span style="color:#000000;">-</span><span style="color:#800080;">1</span><span style="color:#000000;">;
                            </span><span style="color:#0000ff;">return</span><span style="color:#0000ff;">false</span><span style="color:#000000;">;   
                        }

                        ExitCode </span><span style="color:#000000;">=</span><span style="color:#800080;">0</span><span style="color:#000000;">;
                        </span><span style="color:#0000ff;">return</span><span style="color:#0000ff;">true</span><span style="color:#000000;">;
                    }
                }
            }
            </span><span style="color:#0000ff;">catch</span><span style="color:#000000;"> (Exception ex)
            {
                Exception e </span><span style="color:#000000;">=</span><span style="color:#000000;"> ex;

                </span><span style="color:#0000ff;">while</span><span style="color:#000000;"> (e </span><span style="color:#000000;">!=</span><span style="color:#0000ff;">null</span><span style="color:#000000;">)
                {
                    Log.LogError(e.GetType().FullName </span><span style="color:#000000;">+</span><span style="color:#800000;">"</span><span style="color:#800000;">: </span><span style="color:#800000;">"</span><span style="color:#000000;">+</span><span style="color:#000000;"> e.Message);

                    </span><span style="color:#0000ff;">foreach</span><span style="color:#000000;"> (</span><span style="color:#0000ff;">string</span><span style="color:#000000;"> stackLine </span><span style="color:#0000ff;">in</span><span style="color:#000000;"> e.StackTrace.Split(</span><span style="color:#0000ff;">new</span><span style="color:#000000;">[] { </span><span style="color:#800000;">"</span><span style="color:#800000;">\r\n</span><span style="color:#800000;">"</span><span style="color:#000000;"> }, StringSplitOptions.RemoveEmptyEntries))
                        Log.LogError(stackLine);

                    e </span><span style="color:#000000;">=</span><span style="color:#000000;"> e.InnerException;
                }

                ExitCode </span><span style="color:#000000;">=</span><span style="color:#000000;">-</span><span style="color:#800080;">1</span><span style="color:#000000;">;

                </span><span style="color:#0000ff;">return</span><span style="color:#0000ff;">false</span><span style="color:#000000;">;
            }
        }</span></pre>
<!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com -->

</div>
Now build the project and deploy the xUnit build task to the server. To realize the xUnit build integration just follow the steps you find on the nunit4teambuild site and use the previous mentioned modifications. After this, you should be set to go.

<strong>BTW</strong>: In the nunit4teambuild they use nxslt2, I used nxslt3. So depending on which one you use, modify the script accordingly.
